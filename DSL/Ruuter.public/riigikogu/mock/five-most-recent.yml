declaration:
  call: declare
  version: 0.1
  name: "MOCK - 5 most recent voting results service"
  description: "Provides mock information for 5 most-recent voting results"
  method: get
  returns: json
  namespace: common-services

prepareVariables:
  assign:
    offSet: 4
    end: ${new Date().toISOString().split('T')[0]}
    start: ${new Date(new Date(end).setDate(new Date(end).getDate() - offSet)).toISOString().split('T')[0]}
  next: apiCall

apiCall:
  call: reflect.mock
  args:
    request:
      url: https://api.riigikogu.ee/api/votings?endDate=${end}&lang=ET&startDate=${start}
    response:
      data:
        sessions:
          - uuid: "12951e8e-d7c5-4fe9-abf0-88c18b2097de"
            votingNumber: 13445
            type:
              code: "AVALIK"
              value: "Avalik"
            description: "Tagasi lükkamine"
            startDateTime: "2024-10-17T10:37:53.9"
            endDateTime: "2024-10-17T10:38:13.89"
            present: 54
            absent: 47
            inFavor: 35
            against: 15
            neutral: 0
            abstained: 51 
            relatedDraft:
              uuid: "409b4550-4edb-414b-9367-12bc3828402f"
              title: "Tsiviilkohtumenetluse seadustiku ja täitemenetluse seadustiku rakendamise seaduse muutmise seadus"
              mark: 439
              copyOrOriginal: "ORIGINAL"
            sitting:
              uuid: "e92afab7-065f-4730-b051-813dd765d613"
              title: "Täiskogu korraline istung neljapäev, 17.10.2024 10:00"
              volumeType: "plenarySittingVolume"
              created: "2024-05-13T12:46:40.242"
              copyOrOriginal: "ORIGINAL"
            chairman:
              uuid: "906f1a0a-0000-4a96-866c-b30f2b6adc49"
              fullName: "Toomas Kivimägi"

          - uuid: "409b4550-4edb-414b-9367-12bc3828402f"
            votingNumber: 13444
            type:
              code: "AVALIK"
              value: "Avalik"
            description: "Seaduseelnõu vastuvõtmine"
            startDateTime: "2024-10-17T10:10:00.1"
            endDateTime: "2024-10-17T10:20:13.89"
            present: 60
            absent: 40
            inFavor: 40
            against: 10
            neutral: 5
            abstained: 5
            relatedDraft:
              uuid: "abcdefg-1234-5678-91011-121314151617"
              title: "Eesti Vabariigi seadus nr 5"
              mark: 501
              copyOrOriginal: "ORIGINAL"
            sitting:
              uuid: "zxcvbnm-7654-3210-09876-543210123456"
              title: "Täiskogu korraline istung esmaspäev, 17.10.2024 10:00"
              volumeType: "plenarySittingVolume"
              created: "2024-05-13T10:46:40.242"
              copyOrOriginal: "ORIGINAL"
            chairman:
              uuid: "dfrty789-0000-4a96-866c-b30f2b6adc49"
              fullName: "Jüri Ratas"
  error: requestError
  result: mockData
  next: votingDataFormatting

votingDataFormatting:
  assign:
    recentVotings: ${mockData.response.body.data}
    votingDetails: ${recentVotings.flatMap(session => session.votings)
      .filter(voting => voting.type.value === "Avalik" && voting.relatedDraft)
      .sort((voting1, voting2) => new Date(voting2.startDateTime) - new Date(voting1.startDateTime)).slice(0, 5)}  # Take the first 5 items
  # error: dataFormattingError
  next: assignResults

assignResults:
  assign:
    results:
      - title: ${recentVotings.sessions[0].relatedDraft.title}
        present: ${recentVotings.sessions[0].present}
        absent: ${recentVotings.sessions[0].absent}
        inFavor: ${recentVotings.sessions[0].inFavor}
        against: ${recentVotings.sessions[0].against}
        neutral: ${recentVotings.sessions[0].neutral}
        abstained: ${recentVotings.sessions[0].abstained}
      - title: ${recentVotings.sessions[1].relatedDraft.title}
        present: ${recentVotings.sessions[1].present}
        absent: ${recentVotings.sessions[1].absent}
        inFavor: ${recentVotings.sessions[1].inFavor}
        against: ${recentVotings.sessions[1].against}
        neutral: ${recentVotings.sessions[1].neutral}
        abstained: ${recentVotings.sessions[1].abstained}
  error: assignResultsError
  next: returnResults

returnResults:
  return: ${results}
  next: end

requestError:
  return: "Error: failed to get last 5 votings data."
  next: end

dataFormattingError:
  return: "Error: failed to format voting data"
  next: end

assignResultsError:
  return: "Error: failed to assign results"
  next: end
